<!--pages/admin-goods/admin-goods.wxml-->
<view class="admin-goods-page">

  <!-- 分类筛选 -->
  <view class="cat-tabs">
    <view 
      class="cat-tab {{currentCat === idx ? 'active' : ''}}"
      wx:for="{{categories}}"
      wx:key="id"
      wx:for-index="idx"
      bindtap="onCatChange"
      data-index="{{idx}}"
    >{{item.name}}</view>
  </view>

  <!-- 菜品列表 -->
  <scroll-view class="goods-scroll" scroll-y enhanced show-scrollbar="{{false}}">
    <view class="goods-list">
      <view class="goods-card" wx:for="{{displayGoods}}" wx:key="id">
        <view class="thumb-wrapper">
          <image class="goods-thumb" src="{{item.image}}" mode="aspectFill" lazy-load catchtap="onChangeImage" data-id="{{item.id}}"></image>
          <view class="thumb-edit-hint">换图</view>
        </view>
        <view class="goods-body">
          <view class="goods-top">
            <text class="goods-name" catchtap="onEditName" data-id="{{item.id}}" data-name="{{item.name}}">{{item.name}}</text>
            <view class="sale-tag {{item.onSale ? 'on' : 'off'}}">
              {{item.onSale ? '在售' : '已下架'}}
            </view>
          </view>
          <text class="goods-desc">{{item.desc}}</text>
          <view class="goods-specs-row">
            <view class="goods-specs" wx:if="{{item.hasSpecs}}">
              <text class="spec-chip" wx:for="{{item.specs}}" wx:for-item="spec" wx:key="name">
                {{spec.name}} +¥{{spec.price}}
              </text>
            </view>
            <view class="op-spec" catchtap="onEditSpecs" data-id="{{item.id}}">
              {{item.hasSpecs ? '编辑加料' : '+ 加料'}}
            </view>
          </view>
          <view class="goods-bottom">
            <view class="price-box">
              <text class="yen">¥</text>
              <text class="price-val">{{item.price}}</text>
            </view>
            <view class="goods-ops">
              <view class="op-delete" catchtap="onDeleteGoods" data-id="{{item.id}}" data-name="{{item.name}}">
                删除
              </view>
              <view class="op-toggle" catchtap="onToggleSale" data-id="{{item.id}}">
                {{item.onSale ? '下架' : '上架'}}
              </view>
              <view class="op-edit" catchtap="onEditPrice" data-id="{{item.id}}" data-price="{{item.price}}">
                改价
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 空状态 -->
      <view class="empty-hint" wx:if="{{displayGoods.length === 0}}">
        <text>当前分类暂无菜品</text>
      </view>
    </view>
  </scroll-view>

  <!-- 底部新增按钮 -->
  <view class="add-bar" bindtap="onShowAddForm">
    <text class="add-icon">+</text>
    <text>新增菜品</text>
  </view>

  <!-- 新增菜品弹窗 -->
  <view class="form-mask {{showAddForm ? 'show' : ''}}" bindtap="onHideAddForm"></view>
  <view class="form-popup {{showAddForm ? 'show' : ''}}">
    <view class="form-header">
      <text class="form-title">新增菜品</text>
      <view class="form-close" bindtap="onHideAddForm">✕</view>
    </view>

    <view class="form-body">
      <view class="form-item">
        <text class="form-label">菜品名称</text>
        <input class="form-input" placeholder="例如：番茄牛腩粉" value="{{newGoods.name}}" bindinput="onNewNameInput" />
      </view>

      <view class="form-item">
        <text class="form-label">描述</text>
        <input class="form-input" placeholder="一句话描述菜品特色" value="{{newGoods.desc}}" bindinput="onNewDescInput" />
      </view>

      <view class="form-item">
        <text class="form-label">价格（元）</text>
        <input class="form-input" type="digit" placeholder="例如：12" value="{{newGoods.price}}" bindinput="onNewPriceInput" />
      </view>

      <view class="form-item">
        <text class="form-label">菜品图片</text>
        <view class="image-picker">
          <view class="image-preview" wx:if="{{tempImagePath}}">
            <image src="{{tempImagePath}}" mode="aspectFill" class="preview-img"></image>
            <view class="image-remove" catchtap="onRemoveImage">✕</view>
          </view>
          <view class="image-add" wx:else bindtap="onChooseImage">
            <text class="image-add-icon">📷</text>
            <text class="image-add-text">拍照/相册</text>
          </view>
        </view>
      </view>

      <!-- 加料管理 -->
      <view class="form-item">
        <view class="form-label-row">
          <text class="form-label">加料（可选）</text>
          <view class="spec-add-btn" bindtap="onAddNewSpec">+ 添加</view>
        </view>
        <view class="spec-edit-list" wx:if="{{newSpecs.length > 0}}">
          <view class="spec-edit-row" wx:for="{{newSpecs}}" wx:key="index">
            <input class="spec-name-input" placeholder="名称" value="{{item.name}}" bindinput="onNewSpecNameInput" data-idx="{{index}}" />
            <input class="spec-price-input" type="digit" placeholder="加价" value="{{item.price}}" bindinput="onNewSpecPriceInput" data-idx="{{index}}" />
            <text class="spec-price-unit">元</text>
            <view class="spec-remove-btn" catchtap="onRemoveNewSpec" data-idx="{{index}}">✕</view>
          </view>
        </view>
        <view class="spec-empty" wx:else>
          <text>点击“+ 添加”来设置加料项</text>
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">所属分类</text>
        <picker mode="selector" range="{{categories}}" range-key="name" bindchange="onNewCatChange">
          <view class="form-picker">
            <text wx:if="{{newGoods.catId}}">
              <block wx:for="{{categories}}" wx:key="id">
                <block wx:if="{{item.id === newGoods.catId}}">{{item.name}}</block>
              </block>
            </text>
            <text wx:else class="form-placeholder">请选择分类</text>
            <text class="picker-arrow">▼</text>
          </view>
        </picker>
      </view>
    </view>

    <view class="form-footer">
      <view class="form-btn cancel" bindtap="onHideAddForm">取消</view>
      <view class="form-btn confirm" bindtap="onSubmitAdd">确认新增</view>
    </view>
  </view>

  <!-- 编辑加料弹窗（已有菜品） -->
  <view class="form-mask {{showSpecEditor ? 'show' : ''}}" bindtap="onHideSpecEditor"></view>
  <view class="form-popup {{showSpecEditor ? 'show' : ''}}">
    <view class="form-header">
      <text class="form-title">{{editingGoodsName}} - 加料管理</text>
      <view class="form-close" bindtap="onHideSpecEditor">✕</view>
    </view>

    <view class="form-body">
      <view class="spec-edit-list" wx:if="{{editSpecs.length > 0}}">
        <view class="spec-edit-row" wx:for="{{editSpecs}}" wx:key="index">
          <input class="spec-name-input" placeholder="加料名称" value="{{item.name}}" bindinput="onEditSpecNameInput" data-idx="{{index}}" />
          <input class="spec-price-input" type="digit" placeholder="加价" value="{{item.price}}" bindinput="onEditSpecPriceInput" data-idx="{{index}}" />
          <text class="spec-price-unit">元</text>
          <view class="spec-remove-btn" catchtap="onRemoveEditSpec" data-idx="{{index}}">✕</view>
        </view>
      </view>
      <view class="spec-empty" wx:else>
        <text>暂无加料，点击下方添加</text>
      </view>
      <view class="spec-add-row" bindtap="onAddEditSpec">
        <text class="spec-add-icon">+</text>
        <text>添加加料项</text>
      </view>
    </view>

    <view class="form-footer">
      <view class="form-btn cancel" bindtap="onHideSpecEditor">取消</view>
      <view class="form-btn confirm" bindtap="onSaveSpecs">保存</view>
    </view>
  </view>

</view>
